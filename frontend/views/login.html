<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>Login</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <main>
      <div class="container marketing" style="margin-top: 100px">
        <div class="row">
          <form id="login-form">
            <div class="mb-3">
              <label class="form-label">Email address</label>
              <input type="email" name="email" class="form-control" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Password</label>
              <input
                type="password"
                name="password"
                class="form-control"
                required
                minlength="4"
              />
            </div>

            <button type="submit" class="btn btn-primary">Login</button>
          </form>
        </div>
      </div>
    </main>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.js"></script>

    <script src="utils/constants.js"></script>
    <script src="utils/utils.js"></script>
    <script src="services/user-service.js"></script>

    <script type="text/javascript">
      // Example: your UserService should expose a login() that returns a token
      // Adjust endpoint/response handling inside user-service.js if needed.

      $(function () {
        $("#login-form").validate({
          submitHandler: function (form) {
            const payload = {
              email: $(form).find('input[name="email"]').val(),
              password: $(form).find('input[name="password"]').val(),
            };

            UserService.login(payload)
              .then((res) => {
                // Accept either {token:"..."} or raw token string
                const token = res?.token || res;
                if (!token) {
                  toastr.error("Login succeeded but token is missing.");
                  return;
                }

                localStorage.setItem("token", token);

                // Extract patient data from JWT payload
                const jwt = Utils.parseJwt(token);

                // Your backend decides names. These are common patterns:
                // - patientId / id / sub
                // - firstName/lastName OR name
                // - role / roles
                const patient = {
                  patientId: jwt?.patientId ?? jwt?.id ?? jwt?.sub ?? null,
                  firstName: jwt?.firstName ?? null,
                  lastName: jwt?.lastName ?? null,
                  name: jwt?.name ?? null,
                  email: jwt?.email ?? payload.email ?? null,
                  role: jwt?.role ?? (Array.isArray(jwt?.roles) ? jwt.roles[0] : null),
                  raw: jwt, // keep full payload for debugging/usage
                };

                localStorage.setItem("patient", JSON.stringify(patient));

                toastr.success("Logged in successfully!");
                // Redirect wherever your app starts
                window.location.href = "index.html";
              })
              .catch((err) => {
                console.error(err);
                toastr.error("Invalid email or password.");
              });

            return false;
          },
        });
      });

      // If you still need init logic
      UserService.init && UserService.init();
    </script>
  </body>
</html>


